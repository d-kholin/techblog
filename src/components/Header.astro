---
import { SITE_TITLE } from '../consts';
import HeaderLink from './HeaderLink.astro';
---

<header>
	<nav>
		<h2><a href="/">{SITE_TITLE}</a></h2>
                <div class="internal-links">
                        <HeaderLink href="/">Home</HeaderLink>
                        <HeaderLink href="/blog">Blog</HeaderLink>
                        <HeaderLink href="/about">About</HeaderLink>
                </div>
                <div class="utility-links">
                <button id="open-search" aria-label="Search">
                        <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32">
                                <path
                                        fill="currentColor"
                                        d="M11.742 10.344l3.387 3.387-1.398 1.398-3.387-3.387a6.5 6.5 0 111.398-1.398zM6.5 11a4.5 4.5 0 100-9 4.5 4.5 0 000 9z"
                                />
                        </svg>
                </button>
                        <div class="social-links">
                                <a href="https://www.linkedin.com/in/michael-griffiths-aba52991/" target="_blank">
                                        <span class="sr-only">Follow Me on LinkedIn</span>
                                        <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32"
                                                >  <path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"/>
                                        </svg>
                                </a>
                                <a href="https://github.com/d-kholin/techblog" target="_blank">
                                        <span class="sr-only">Go to my GitHub repo</span>
                                        <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32"
                                                ><path
                                                        fill="currentColor"
                                                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                                                ></path></svg
                                        >
                                </a>
                        </div>
                </div>
	</nav>
</header>
<div id="search-overlay" hidden>
<div class="search-box">
<button id="close-search" aria-label="Close Search">×</button>
<label for="search-input" class="sr-only">Search</label>
<input id="search-input" type="search" placeholder="Search posts" />
<div id="results">
<section id="posts-section" hidden>
<h3>Posts</h3>
<ul id="post-results"></ul>
</section>
<section id="content-section" hidden>
<h3>Content</h3>
<ul id="content-results"></ul>
</section>
</div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
const overlay = document.getElementById('search-overlay');
const openBtn = document.getElementById('open-search');
const closeBtn = document.getElementById('close-search');
const input = document.getElementById('search-input');
const postResults = document.getElementById('post-results');
const contentResults = document.getElementById('content-results');
const postsSection = document.getElementById('posts-section');
const contentSection = document.getElementById('content-section');
let entries = [];

async function loadIndex() {
if (entries.length) return;
const res = await fetch('/search.json');
entries = await res.json();
}

function escapeRegExp(str) {
return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function createSnippet(text, query) {
const lower = text.toLowerCase();
const q = query.toLowerCase();
const idx = lower.indexOf(q);
if (idx === -1) return '';
const start = Math.max(0, idx - 40);
const end = Math.min(text.length, idx + q.length + 40);
let snippet = text.slice(start, end);
const esc = escapeRegExp(query);
const regex = new RegExp(esc, 'gi');
snippet = snippet.replace(regex, (m) => `<mark>${m}</mark>`);
return `${start > 0 ? '…' : ''}${snippet}${end < text.length ? '…' : ''}`;
}

function open() {
overlay.removeAttribute('hidden');
input.focus();
loadIndex();
}

function close() {
overlay.setAttribute('hidden', '');
input.value = '';
postResults.innerHTML = '';
contentResults.innerHTML = '';
postsSection.hidden = true;
contentSection.hidden = true;
}

openBtn.addEventListener('click', open);
closeBtn.addEventListener('click', close);
overlay.addEventListener('click', (e) => {
if (e.target === overlay) close();
});
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') close();
});

input.addEventListener('input', () => {
const query = input.value.trim();
postResults.innerHTML = '';
contentResults.innerHTML = '';
postsSection.hidden = true;
contentSection.hidden = true;
if (!query) return;
const esc = escapeRegExp(query);
const regex = new RegExp(esc, 'i');
entries.forEach((p) => {
if (regex.test(p.title) || regex.test(p.description) || regex.test(p.body)) {
const li = document.createElement('li');
const a = document.createElement('a');
a.href = p.url;
const titleRegex = new RegExp(esc, 'gi');
const highlightedTitle = p.title.replace(titleRegex, (m) => `<mark>${m}</mark>`);
a.innerHTML = `<strong>${highlightedTitle}</strong>`;
const snippet = createSnippet(p.body, query);
if (snippet) {
const preview = document.createElement('p');
preview.innerHTML = snippet;
a.appendChild(preview);
}
li.appendChild(a);
if (p.type === 'post') {
postResults.appendChild(li);
postsSection.hidden = false;
} else {
contentResults.appendChild(li);
contentSection.hidden = false;
}
}
});
});
});
</script>
<style>
	header {
		margin: 0;
		padding: 0 1em;
		background: white;
		box-shadow: 0 2px 8px rgba(var(--black), 5%);
	}
	h2 {
		margin: 0;
		font-size: 1em;
	}

	h2 a,
	h2 a.active {
		text-decoration: none;
	}
	nav {
		display: flex;
		align-items: center;
		justify-content: space-between;
	}
	nav a {
		padding: 1em 0.5em;
		color: var(--black);
		border-bottom: 4px solid transparent;
		text-decoration: none;
	}
        nav a.active {
                text-decoration: none;
                border-bottom-color: var(--accent);
        }
        .utility-links {
                display: flex;
                align-items: center;
        }
        .utility-links button {
                display: flex;
                background: none;
                border: none;
                padding: 0;
                cursor: pointer;
        }
        .social-links,
        .social-links a {
                display: flex;
        }
        #search-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding-top: 10vh;
        }
        #search-overlay[hidden] {
                display: none;
        }
        .search-box {
                background: white;
                padding: 1em;
                max-width: 600px;
                width: 90%;
                border-radius: 8px;
                position: relative;
        }
        #close-search {
                position: absolute;
                top: 0.5em;
                right: 0.5em;
                background: none;
                border: none;
                font-size: 1.5em;
                line-height: 1;
                cursor: pointer;
        }
        #search-input {
                width: 100%;
                padding: 0.5rem;
                font-size: 1rem;
                border-radius: 4px;
                background: white;
                color: rgb(var(--black));
                border: 1px solid rgb(var(--black));
        }
        #results {
                margin: 1em 0 0;
        }
        #results ul {
                list-style: none;
                padding: 0;
                margin: 0;
        }
        #results li {
                margin: 0.5em 0;
        }
        #results a {
                text-decoration: none;
                color: rgb(var(--black));
                display: block;
        }
        #results a:hover {
                text-decoration: none;
        }
        #results p {
                margin: 0.25em 0 0;
        }
        @media (max-width: 720px) {
                .social-links {
                        display: none;
                }
        }
</style>
